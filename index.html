<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Qu·∫£n l√Ω ƒëi·ªÉm n√¢ng cao</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px 8px; text-align: center; }
    th { background-color: #f0f0f0; }
    td.name-left { text-align: left; }
    .controls { margin-bottom: 20px; }
    .controls input, .controls button, .controls select { margin-right: 10px; padding: 6px; }
    .chart-container { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 30px; }
    .chart-box { flex: 1 1 300px; }
    .low-score { background-color: #ffe5e5; color: red; font-weight: bold; }
    .high-toan2 { background-color: #d1e7dd; color: #065f46; font-weight: bold; }
    .scrollable-table { max-height: 400px; overflow-y: auto; display: block; }
    .inline-form { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    .inline-form input { width: 140px; padding: 6px; }
  </style>
</head>
<body>
  <h2>üìö Qu·∫£n l√Ω danh s√°ch ƒëi·ªÉm & Bi·ªÉu ƒë·ªì</h2>

  <div class="controls">
    <input type="file" id="fileInput" accept=".xlsx, .xls" />
    <input type="file" id="excelAddInput" accept=".xlsx, .xls" />
    <button onclick="exportExcel()">üíæ Xu·∫•t Excel</button>
    <input type="text" id="searchInput" placeholder="üîç T√¨m theo H·ªç v√† t√™n, M√£ s·ªë ho·∫∑c SBD" oninput="renderTable()" />
  </div>

  <div class="inline-form">
    <input placeholder="H·ªç v√† t√™n" id="add-name" />
    <input placeholder="SBD" id="add-sbd" />
    <input placeholder="M√£ s·ªë" id="add-maso" />
    <input placeholder="Anh" id="add-anh" />
    <input placeholder="VƒÉn" id="add-van" />
    <input placeholder="To√°n" id="add-toan" />
    <input placeholder="To√°n 2" id="add-toan2" />
    <button onclick="addStudentFromForm()">‚ûï Th√™m h·ªçc sinh</button>
  </div>

  <div class="scrollable-table">
    <table id="dataTable">
      <thead>
        <tr>
          <th>STT</th>
          <th>H·ªç v√† t√™n</th>
          <th>SBD</th>
          <th>M√£ s·ªë</th>
          <th>Anh</th>
          <th>VƒÉn</th>
          <th>To√°n</th>
          <th>To√°n 2</th>
          <th>T·ªïng ƒëi·ªÉm</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="chart-container" id="chartContainer">
    <div class="chart-box"><canvas id="chart-Anh"></canvas></div>
    <div class="chart-box"><canvas id="chart-VƒÉn"></canvas></div>
    <div class="chart-box"><canvas id="chart-To√°n"></canvas></div>
    <div class="chart-box"><canvas id="chart-To√°n2"></canvas></div>
    <div class="chart-box"><canvas id="chart-T·ªïng"></canvas></div>
  </div>

  <script>
    let data = [];
    let charts = {};
    const subjects = ["Anh", "VƒÉn", "To√°n", "To√°n 2", "T·ªïng"];

    document.getElementById("fileInput").addEventListener("change", handleMainExcel);
    document.getElementById("excelAddInput").addEventListener("change", handleAddExcel);

    function handleMainExcel(e) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = function (e) {
        const workbook = XLSX.read(e.target.result, { type: "binary" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const raw = XLSX.utils.sheet_to_json(sheet, { defval: "" });
        data = removeDuplicates(processRawData(raw));
        renderTable();
      };
      reader.readAsBinaryString(file);
    }

    function handleAddExcel(e) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = function (e) {
        const workbook = XLSX.read(e.target.result, { type: "binary" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const raw = XLSX.utils.sheet_to_json(sheet, { defval: "" });
        const newData = processRawData(raw);
        data = removeDuplicates(data.concat(newData));
        renderTable();
      };
      reader.readAsBinaryString(file);
    }

    function removeDuplicates(arr) {
      const seen = new Set();
      return arr.filter(item => {
        const key = item["SBD"] + "-" + item["M√£ s·ªë"];
        if (seen.has(key)) return false;
        seen.add(key);
        return true;
      });
    }

    function processRawData(raw) {
      return raw.map(row => {
        const toan2 = parseFloat(row["To√°n 2"]) || 0;
        const tong = (parseFloat(row["Anh"]) || 0) + (parseFloat(row["VƒÉn"]) || 0) + (parseFloat(row["To√°n"]) || 0) + toan2 * 2;
        return {
          "H·ªç v√† t√™n": row["H·ªç v√† t√™n"] || "",
          "SBD": row["SBD"] || "",
          "M√£ s·ªë": row["M√£ s·ªë"] || "",
          "Anh": parseFloat(row["Anh"]) || 0,
          "VƒÉn": parseFloat(row["VƒÉn"]) || 0,
          "To√°n": parseFloat(row["To√°n"]) || 0,
          "To√°n 2": toan2,
          "T·ªïng": tong
        };
      });
    }

    function renderTable() {
      const keyword = document.getElementById("searchInput").value.toLowerCase();
      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";

      const filtered = data.filter(item =>
        item["H·ªç v√† t√™n"].toLowerCase().includes(keyword) ||
        item["M√£ s·ªë"].toString().toLowerCase().includes(keyword) ||
        item["SBD"].toString().toLowerCase().includes(keyword)
      );

      filtered.forEach((item, index) => {
        const row = document.createElement("tr");

        const sttCell = document.createElement("td");
        sttCell.textContent = index + 1;
        row.appendChild(sttCell);

        ["H·ªç v√† t√™n", "SBD", "M√£ s·ªë", "Anh", "VƒÉn", "To√°n", "To√°n 2", "T·ªïng"].forEach(key => {
          const cell = document.createElement("td");
          cell.textContent = item[key];
          if (key === "H·ªç v√† t√™n") cell.classList.add("name-left");
          const val = parseFloat(item[key]);
          if (!isNaN(val)) {
            if (val < 5 && key !== "To√°n 2" && key !== "T·ªïng") cell.classList.add("low-score");
            if (key === "To√°n 2" && val > 8) cell.classList.add("high-toan2");
            if (key === "T·ªïng" && val < 5) cell.classList.add("low-score");
          }
          row.appendChild(cell);
        });

        tbody.appendChild(row);
      });

      drawCharts(filtered);
    }

    function addStudentFromForm() {
      const hoTen = document.getElementById("add-name").value;
      const sbd = document.getElementById("add-sbd").value;
      const maSo = document.getElementById("add-maso").value;
      const anh = parseFloat(document.getElementById("add-anh").value) || 0;
      const van = parseFloat(document.getElementById("add-van").value) || 0;
      const toan = parseFloat(document.getElementById("add-toan").value) || 0;
      const toan2 = parseFloat(document.getElementById("add-toan2").value) || 0;
      const tong = anh + van + toan + toan2 * 2;

      if (hoTen && sbd && maSo) {
        const newStudent = { "H·ªç v√† t√™n": hoTen, "SBD": sbd, "M√£ s·ªë": maSo, "Anh": anh, "VƒÉn": van, "To√°n": toan, "To√°n 2": toan2, "T·ªïng": tong };
        data.push(newStudent);
        data = removeDuplicates(data);
        renderTable();
      }
    }

    function exportExcel() {
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Danh_sach");
      XLSX.writeFile(wb, "Danh_sach_diem_xuat.xlsx");
    }

    function drawCharts(filteredData) {
      const ranges = { "Anh": 10, "VƒÉn": 10, "To√°n": 10, "To√°n 2": 10, "T·ªïng": 50 };
      subjects.forEach(subject => {
        const maxVal = ranges[subject];
        const values = filteredData.map(item => Math.round(item[subject]));
        const counts = Array(maxVal + 1).fill(0);
        values.forEach(v => { if (v >= 0 && v <= maxVal) counts[v]++; });

        const ctx = document.getElementById("chart-" + subject.replace(" ", "")).getContext("2d");
        if (charts[subject]) charts[subject].destroy();

        charts[subject] = new Chart(ctx, {
          type: "bar",
          data: {
            labels: counts.map((_, i) => i),
            datasets: [{ label: `T·∫ßn su·∫•t ƒëi·ªÉm - ${subject}`, data: counts, backgroundColor: "#4f46e5" }]
          },
          options: {
            responsive: true,
            scales: { y: { beginAtZero: true, stepSize: 1 }, x: { title: { display: true, text: "ƒêi·ªÉm" } } },
            plugins: { legend: { display: false }, title: { display: true, text: `Ph√¢n ph·ªëi ƒëi·ªÉm ${subject}` } }
          }
        });
      });
    }
  </script>
</body>
</html>
